<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Sedes y Dependencias</title>
  <link rel="stylesheet" href="../styles/theme.css">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>

  <header>
    <h1>DataNet Inventario</h1>
    <div id="userInfo"></div>
  </header>

  <div class="sidebar">
    <a href="../../index.html"><i class="ph-fill ph-house"></i> Inicio</a>
    <a href="equipos.html"><i class="ph-fill ph-desktop"></i> Gestión de Equipos</a>
    <a href="usuarios.html"><i class="ph-fill ph-users"></i> Gestión de Usuarios</a>
    <a href="licencias.html"><i class="ph-fill ph-file-text"></i> Gestión de Licencias</a>
    <a href="sedes_dependencias.html" class="active"><i class="ph-fill ph-buildings"></i> Sedes y Dependencias</a>
    <a href="movimientos.html"><i class="ph-fill ph-arrows-left-right"></i> Movimientos</a>
    <a href="auditoria.html"><i class="ph-fill ph-list-checks"></i> Auditoría</a>
    <a href="notificaciones.html"><i class="ph-fill ph-bell"></i> Notificaciones</a>
    <button class="logout-button" id="btnLogout"><i class="ph-fill ph-sign-out"></i> Cerrar sesión</button>
  </div>

  <main>
    <h1>Gestión de Sedes y Dependencias</h1>
    <div style="display: flex; gap: 20px;">
        <div class="card" style="flex: 1;">
          <h2>Crear Sede</h2>
          <select id="selEmpresaSede"></select>
          <input id="txtSedeNombre" placeholder="Nombre de la sede" />
          <input id="txtSedeDireccion" placeholder="Dirección" />
          <button id="btnCrearSede" class="btn btn-primary">Crear Sede</button>
        </div>

        <div class="card" style="flex: 1;">
          <h2>Crear Dependencia</h2>
          <select id="selEmpresaDep"></select>
          <select id="selSedeDep"></select>
          <input id="txtDepNombre" placeholder="Nombre de la dependencia" />
          <button id="btnCrearDep" class="btn btn-primary">Crear Dependencia</button>
        </div>
    </div>
    
    <div class="card">
        <h2>Listados</h2>
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h3>Sedes</h3>
                <ul id="sedes-list"></ul>
            </div>
            <div style="flex: 1;">
                <h3>Dependencias</h3>
                <ul id="dependencias-list"></ul>
            </div>
        </div>
    </div>
  </main>

  <script type="module">
    import { getDB } from "../scripts/storage.js";
    import { createEmpresa, createSede, createDependencia } from "../scripts/domain.js";

    const selEmpresaSede = document.getElementById('selEmpresaSede');
    const selEmpresaDep = document.getElementById('selEmpresaDep');
    const selSedeDep = document.getElementById('selSedeDep');
    const sedesList = document.getElementById('sedes-list');
    const dependenciasList = document.getElementById('dependencias-list');

    function loadEmpresas() {
      const db = getDB();
      const empresasOptions = db.empresas.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
      selEmpresaSede.innerHTML = empresasOptions;
      selEmpresaDep.innerHTML = empresasOptions;
      loadSedes();
    }

    function loadSedes() {
      const db = getDB();
      const empId = selEmpresaDep.value;
      const sedes = db.sedes.filter(s => s.empresa_id === empId);
      selSedeDep.innerHTML = sedes.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
      
      sedesList.innerHTML = db.sedes.map(s => `<li>${s.nombre} (${db.empresas.find(e=>e.id===s.empresa_id)?.nombre})</li>`).join('');
      loadDependencias();
    }

    function loadDependencias() {
        const db = getDB();
        const sedeId = selSedeDep.value;
        const dependencias = db.dependencias.filter(d => d.sede_id === sedeId);
        dependenciasList.innerHTML = dependencias.map(d => `<li>${d.nombre} (${db.sedes.find(s=>s.id===d.sede_id)?.nombre})</li>`).join('');
    }

    selEmpresaDep.onchange = loadSedes;
    selSedeDep.onchange = loadDependencias;

    document.getElementById('btnCrearSede').onclick = () => {
      const nombre = document.getElementById('txtSedeNombre').value.trim();
      const direccion = document.getElementById('txtSedeDireccion').value.trim();
      const empresa_id = selEmpresaSede.value;
      if (nombre && empresa_id) {
        createSede(empresa_id, nombre, direccion);
        alert("Sede creada");
        loadSedes();
      } else {
        alert("Por favor, seleccione una empresa y ingrese un nombre para la sede.");
      }
    };

    document.getElementById('btnCrearDep').onclick = () => {
      const nombre = document.getElementById('txtDepNombre').value.trim();
      const sede_id = selSedeDep.value;
      if (nombre && sede_id) {
        createDependencia(sede_id, nombre);
        alert("Dependencia creada");
        loadDependencias();
      } else {
        alert("Por favor, seleccione una sede y ingrese un nombre para la dependencia.");
      }
    };

    // Carga inicial
    const db = getDB();
    if (db.empresas.length === 0) {
        createEmpresa("Empresa Demo");
    }
    loadEmpresas();
    
    // Auth
    const usuarioAutenticado = JSON.parse(localStorage.getItem('usuario_autenticado'));
    if (usuarioAutenticado) {
        document.getElementById('userInfo').innerText = `Conectado como: ${usuarioAutenticado.nombre}`;
    }
    document.getElementById('btnLogout')?.addEventListener('click', () => {
      localStorage.removeItem('usuario_autenticado');
      localStorage.removeItem('session_expires');
      location.href = '../../login.html';
    });
  </script>
</body>
</html>
