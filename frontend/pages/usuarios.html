<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Usuarios</title>
  <link rel="stylesheet" href="../styles/theme.css">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
</head>
<body>

  <header>
    <h1>DataNet Inventario</h1>
    <div id="userInfo"></div>
  </header>

  <div class="sidebar">
    <a href="../../index.html"><i class="ph-fill ph-house"></i> Inicio</a>
    <a href="equipos.html"><i class="ph-fill ph-desktop"></i> Gestión de Equipos</a>
    <a href="usuarios.html" class="active"><i class="ph-fill ph-users"></i> Gestión de Usuarios</a>
    <a href="licencias.html"><i class="ph-fill ph-file-text"></i> Gestión de Licencias</a>
    <a href="sedes_dependencias.html"><i class="ph-fill ph-buildings"></i> Sedes y Dependencias</a>
    <a href="movimientos.html"><i class="ph-fill ph-arrows-left-right"></i> Movimientos</a>
    <a href="auditoria.html"><i class="ph-fill ph-list-checks"></i> Auditoría</a>
    <a href="notificaciones.html"><i class="ph-fill ph-bell"></i> Notificaciones</a>
    <button class="logout-button" id="btnLogout"><i class="ph-fill ph-sign-out"></i> Cerrar sesión</button>
  </div>

  <main>
    <h1>Gestión de Usuarios</h1>
    <div style="display: flex; gap: 20px;">
        <div class="card" style="flex: 1;">
          <h2>Crear Usuario</h2>
          <select id="selEmpresa"></select>
          <select id="selSede"></select>
          <select id="selDep"></select>
          <input id="txtNombre" placeholder="Nombre" />
          <input id="txtCorreo" placeholder="Correo" />
          <input id="txtTelefono" placeholder="Teléfono" />
          <input id="txtCargo" placeholder="Cargo" />
          <button id="btnCrearUsuario" class="btn btn-primary">Crear Usuario</button>
        </div>

        <div class="card" style="flex: 2;">
          <h2>Usuarios</h2>
          <table id="usuarios-table">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Cargo</th>
                <th>Dependencia</th>
                <th>Sede</th>
              </tr>
            </thead>
            <tbody id="usuarios-list">
            </tbody>
          </table>
        </div>
    </div>
  </main>

  <script type="module">
    import { getDB } from "../scripts/storage.js";
    import { createUsuario } from "../scripts/domain.js";

    const selEmpresa = document.getElementById('selEmpresa');
    const selSede = document.getElementById('selSede');
    const selDep = document.getElementById('selDep');
    const usuariosList = document.getElementById('usuarios-list');

    function loadEmpresas() {
      const db = getDB();
      selEmpresa.innerHTML = db.empresas.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
      loadSedes();
    }

    function loadSedes() {
      const db = getDB();
      const empId = selEmpresa.value;
      const sedes = db.sedes.filter(s => s.empresa_id === empId);
      selSede.innerHTML = sedes.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
      loadDependencias();
    }

    function loadDependencias() {
      const db = getDB();
      const sedeId = selSede.value;
      const dependencias = db.dependencias.filter(d => d.sede_id === sedeId);
      selDep.innerHTML = dependencias.map(d => `<option value="${d.id}">${d.nombre}</option>`).join('');
      loadUsuarios();
    }
    
    function loadUsuarios() {
        const db = getDB();
        usuariosList.innerHTML = db.usuarios.map(u => {
            const dep = db.dependencias.find(d => d.id === u.dependencia_id);
            const sede = dep ? db.sedes.find(s => s.id === dep.sede_id) : null;
            return `<tr>
                        <td>${u.nombre}</td>
                        <td>${u.cargo}</td>
                        <td>${dep?.nombre || 'N/A'}</td>
                        <td>${sede?.nombre || 'N/A'}</td>
                    </tr>`;
        }).join('');
    }

    selEmpresa.onchange = loadSedes;
    selSede.onchange = loadDependencias;

    document.getElementById('btnCrearUsuario').onclick = () => {
      const dependencia_id = selDep.value;
      const nombre = document.getElementById('txtNombre').value.trim();
      const correo = document.getElementById('txtCorreo').value.trim();
      const telefono = document.getElementById('txtTelefono').value.trim();
      const cargo = document.getElementById('txtCargo').value.trim();
      
      if (dependencia_id && nombre) {
        createUsuario(dependencia_id, { nombre, correo, telefono, cargo });
        alert("Usuario creado");
        loadUsuarios();
      } else {
        alert("Por favor, complete todos los campos.");
      }
    };

    // Carga inicial
    loadEmpresas();

    // Auth
    const usuarioAutenticado = JSON.parse(localStorage.getItem('usuario_autenticado'));
    if (usuarioAutenticado) {
        document.getElementById('userInfo').innerText = `Conectado como: ${usuarioAutenticado.nombre}`;
    }
    document.getElementById('btnLogout')?.addEventListener('click', () => {
      localStorage.removeItem('usuario_autenticado');
      localStorage.removeItem('session_expires');
      location.href = '../../login.html';
    });
  </script>
</body>
</html>
